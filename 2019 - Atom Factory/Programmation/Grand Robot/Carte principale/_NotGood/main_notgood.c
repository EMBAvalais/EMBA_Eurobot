/*
==================================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /*====================================================================================================
=											EMVs - EUROBOT	  										==
===											--------------											==
======================================================================================================
===	 Auteur				: Borgeat Remy				  												==
===  Date				: 8.6.2017																	==
===  Nom du programme 	: InterfaceRoboteQ.mcp (fichier main.c)										==
===  Version 			: V2.0.0.0.0																==
=====================================================================================================*/

#include <30F6014A.h>
#include "DSPIC30F_registers.h"

// Fuses
#fuses NOWDT, HS2_PLL8, NOPUT, NOPROTECT, DEBUG, NOBROWNOUT, NOWRT 
#device ICD=TRUE
// Définit la vitesse du quartz (prendre en compte si PLL employée)
#use delay(clock=80000000)
// Config IIC
#use i2c(master,force_hw,slow,I2C1)
#build(stack=2048)
#use rs232(baud=115200,parity=N,xmit=PIN_F5,rcv=PIN_F4,bits=8,STREAM=ROBOTEQ) // Pour pouvoir utiliser le RS232/2


// Variables utiles (globales)
int1 flagGameEnd=0,flagTimeOut=0;	// Définit si le temps est dépassé
int1 flagBaliseCheck=0;				// Définit si adversaire détecté
int1 flagError=0; 					// Si une erreur doit être affichée
int1 ToDisplay=0;
int1 IsPassedTimeOut=0;
int1 flag_depl_ok = 0;
int1 flag_end = 0;
int1 _Detected = 0; 
int1 balise_on = 0;
int1 flag_error = 0; 
int1 Team=0;
signed int32 ActualPosition = 0;
unsigned int8 value_balise=0;	// Valeur de la balise en détection
unsigned int32 RealTimeMS=0,BeginTimeMS=0,GameTimeMS=0;
unsigned int8 GameTimeS=0;	// Temps de jeu
unsigned int8 Time_detected = 0;
unsigned int8 TIME_tempo_dectected = 6;
unsigned int8 No_erreur = 0; 
unsigned int8 Value_bal = 0; 
unsigned int8 Tempo_bal = 0 ; 


unsigned int8 NoObj = 1;
unsigned int8 NoPts = 1;
unsigned int32 last_obj = 0;

#define TimeLimit 100
unsigned int16 TabZonesInterdites [5] [2] = {0};


// Définit les constantes ASCII, comme il n'a pas l'air de les prendre ...
enum{NUL,SOH,STX,ETX,EOT,ENQ,ACK,BEL,BS,TAB,LF,VT,FF,CR,SO,SI,DLE,DC1,DC2,DC3,DC4,NAK,SYN,ETB,CAN,EM,SUB,ESC,FS,GS,RS,US,SPACE};
enum{Init, Choose_objectif, Check_ZI, Send_depl_action, Send_depl_action_ZI, Depl_action_process, Depl_action_process_ZI,Switch_end_obj,Wait_end} Etat_rob = Init;
	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	#define BalSensitivity 4
	//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

// Inclusion des fichiers sources
#include "driver_moteur.c"
#include "Com_balises.c"
#include "Init.h"
#include "data/___data.h"
#include <math.h>
#include <stdlib.h>
#include "servomoteur/servomoteur.h"
#include "LCD/___LCD.h"
#include "Functions.h"
#include "Deplacement/___Depl.h"
#include "PC/___PC.h"
#include "zonesinterdites/__ZonesInterdites.h"



//////////////////////////////////////////////////////
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! //
// La plage ROM 0 à 511 est réservée aux objectifs. //
// 512/513 : Nombre d'objectifs
// 514/515 : Si des objectifs sont chargés
//////////////////////////////////////////////////////

//********************************************************************************
//*  Main
//****************************************************************************************************
void main(void)
{
	////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////	INITIALISATION DE TOUS LES MODULES	////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////
		// Initialisation du dsPIC
	__Init_dsPIC();	
	__Init_UART();
	delay_ms(1000);
		
		// Si le démarreur n'est pas en place on affiche une erreur
	if(!_DEMA)
	{
		__Affichage_Erreur(1);
	}
				
	// Configuration de la balise
	Balise_config_plage(0, 12, 14);	// En avançant
	delay_ms(100);
	Balise_config_plage(1, 4, 6); // En reculant
	delay_ms(100);

	//On définit de quel côté de la table on se trouve
	if(_TEAM==0)
	{
		_LDT1=0;
		_LDT2=1;
		Team=0;
	}
	else if(_TEAM==1)
	{
		_LDT2=0;
		_LDT1=1;
		Team=1;
	}	
	
	//On enlève l'arrêt d'urgence
	fprintf(ROBOTEQ,"!MG\r");
	
	
	////////////////////////////////////////////////////////////////////////////////////////
			
	////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////	PROGRAMME PRINCIPAL	////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////
	int1 action_ok1 = 0;
	int1 action_ok2 = 0;
	int1 action_ok3 = 0;

	while(1)
	{
		switch(Etat_rob)
		{
			case Init:
			
				if(NbreObjectifs > 0 && !_DEMA  && !flag_end)//si on a des objectifs et qu'il sont charger
				{
					if(BeginTimeMS==0) 
					{
						BeginTimeMS = RealTimeMS;
						delay_ms(1000); 
					}
					__Afficheur_7segments(0);
					__LoadObj(NoObj,NoPts);//on mets l'objectifs dans des variables

					Etat_rob = Check_ZI;//on change d'etat
					Depl_send = 0;		
				}
				else if(NbreObjectifs == 0)
				{
					__Afficheur_7segments(1);
					__ReadObjectifs();	
				}
				else if(_DEMA == 1 && NbreObjectifs != 0)
				{				
					__Afficheur_7segments(2);
					__Init_pos();					
				}
				break;
				
			case Choose_objectif:

				/*
				static int obj_todo = 0; //L'objectif qu'on regarde si on peut le faire

				obj_todo++; //On passe à l'objectif suivant
				__LoadObj(obj_todo, 1); //On récupère les données de l'objectif dans les variables

				if(oTime < (TimeLimit - GameTimeS) && !obj_done && !obj_notcontinuable)
				{
					Etat_rob = Send_depl_action;
				}

				if (obj_todo >= (NbreObjectifs)) 
				{
					obj_todo = 0;
				}
				*/
				break;
				

			case Check_ZI:

				if(checkPath())
				{
					Etat_rob = Send_depl_action;
				}
				else
				{
					findPath();
					Etat_rob = Send_depl_action_ZI;
				}

				break;

			case Send_depl_action:

				if(!Depl_send && !flag_end)//si le deplacement n'as pas ete envoye
				{
					__DeplToDo(oType);//envoie le déplacment
				}
				if(!Action_send && !flag_end)//si l'action n'a pas ete envoyee
				{
					__Action_Writting(obj_Action);//envoie l'action
				}
				if(Depl_send && Action_send && !flag_end)//si tout a ete envoye
				{
					Depl_send = 0;
					Action_send = 0;
					Etat_rob = Depl_action_process;
				}
				break;


			case Send_depl_action_ZI:

				if(!Action_send)//si l'action n'a pas ete envoyee
				{
					__Action_Writting(obj_Action);//envoie l'action
				}

				if(!Depl_send && i_depl< i_rel)
				{
					__PaP(PtsRelai[i_depl].X, PtsRelai[i_depl].Y);
				}

				if (flag_depl_ok)
				{
					i_depl++;
					Depl_send = 0;
					flag_depl_ok = 0;
				}

				if(i_depl >= i_rel && Action_send)//si tout a ete envoye
				{
					Depl_send = 0;
					Action_send = 0;
					Etat_rob = Depl_action_process_ZI;
				}

				__Check_commande_atteint();

				break;

			case Depl_action_process :

				__Check_commande_atteint();
				action_ok1 = __Check_action_end(0xC0); // 1 si ordre fini
				action_ok2 = __Check_action_end(0xC2);
				action_ok3 = __Check_action_end(0xC4);
				if(flag_depl_ok && action_ok1 && action_ok2 && action_ok3 && !flag_end && !_Detected)//on attend que tout soit fini
				{
					if(NoObj==1&&NoPts==1) delay_ms(1000);
					//actualisation position xy 
					Pos_x += Dist_x; 
					Pos_y += Dist_y;
					
					__Afficheur_7segments(3);
	
					Dist_x=0;
					Dist_y=0;
					Dorient = 0;
					balise_on = 0;
					flag_depl_ok = 0;
					action_ok1 = 0;
					action_ok2 = 0;
					action_ok3 = 0;
					Etat_rob = Switch_end_obj;
				}
				break;

			case Depl_action_process_ZI:

				action_ok1 = __Check_action_end(0xC0); // 1 si ordre fini
				action_ok2 = __Check_action_end(0xC2);
				action_ok3 = __Check_action_end(0xC4);
				if(action_ok1 && action_ok2 && action_ok3 && !flag_end && !_Detected)//on attend que tout soit fini
				{
					if(NoObj==1&&NoPts==1) delay_ms(1000);
					//actualisation position xy 
					Pos_x += Dist_x; 
					Pos_y += Dist_y;
					
					__Afficheur_7segments(3);
	
					Dist_x=0;
					Dist_y=0;
					Dorient = 0;
					balise_on = 0;
					flag_depl_ok = 0;
					action_ok1 = 0;
					action_ok2 = 0;
					action_ok3 = 0;
					Etat_rob = Switch_end_obj;
				}
				break;	

			case Switch_end_obj:
				if(keep_obj==0) 
				{
					TabObjectifs[NoObj][1][8] = 0; // mise de la ponderation a 0 --> on le remploie plus
				}
			 	if(Obj_end)//si fini l'objectifs,passe a l'obj suivant
				{
					if(Next_obj!=0) // 0--> passe a l'obj suivant, sinon va a l'obj marquer
					{
						last_obj = NoObj;
						NoObj = Next_Obj;
						NoPts = 1;
						__LoadObj(NoObj,NoPts);//charge le nouveau pts						
					}
					else
					{
						last_obj = NoObj;
						do //prochain objectifs avec pondération de 10
						{
							__Afficheur_7segments(4);
							NoObj++; // on passe a l'objectifs suivant
							NoPts=1; // on reprend au premier pts
							if(NoObj == 10)
							{
								Flag_end = 1;
								Ponderation = 10;
							}
							else __LoadObj(NoObj,NoPts);//charge le nouveau pts
	
						}while(Ponderation!=10);

					}
				}
				else
				{
					if(Pt_commun==1) NoPts+=2; // skip le pts droite
					else NoPts++; // passe au pt suivant suivant																
					__LoadObj(NoObj,NoPts);//charge le nouveau pts
				}	
				if(Pt_commun!=0)//si point pas symetrique
				{
					if(Team)//pt droite
					{
						if(Pt_commun==1) NoPts++; // passe à l'obj suivant (pt droite)
					}
				}
				
				if(!Flag_end) Etat_rob = Init;
				break;
			case Wait_end: //case wait
				if(flag_error) //erreur --> clignotement 7 segments
				{
					__Afficheur_7segments(No_erreur,1);
					delay_ms(1000);
					__Afficheur_7segments(No_erreur,0);
					delay_ms(1000);
				}
				if(flagGameEnd)
				{
					__Afficheur_7segments(99);
					// Desactive tout le reste
					MoveServo(0,20);
					disable_interrupts(INTR_GLOBAL);
					flagGameEnd=0;			
				}				
				break;			
			default:
				__Affichage_erreur(3); 
				break;
				
		}

	}
		////////////////////////////////////////////////////////////////////////////////////

        ////////////////////////////////////////////////////////////////////////////////////
		////////////////////////	ACTION PARALLELES	////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////
		
		/////////////////////////////////////////////////////////////////////////////////////
		///////////////////////        BALISE          //////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////
		if(flagBaliseCheck && !flag_end && balise_on && !flag_error)
      	{
        	Value_bal = Check_balise(); 			//Recuperation de la valeur de la bailse
        	tempo_bal++; 							//temporisation de la balise, d'une fois detecte, il faut passer 4  tempo bal = 4 pour continuer
	        if(Value_bal>=MAX_VALUE_DETECT_BALISE) 	//si adversaire trop proche
	        {   
	       		tempo_bal = 0;						//remise a 0 de la tempo
           		__Afficheur_7segments(44);
	           	_LED2,_LED3,_LED4 = 1;
	           	_Detected = 1;						//indique que l'on a detecte l'adversaire
	        
	            /////////////////// Arret du robot ///////////////////////////////////////
	            fprintf(ROBOTEQ,"^MDEC 1 9000_^MDEC 2 9000\r");	//rampe de dec. plus raide 
	            delay_ms(20);
	            fprintf(ROBOTEQ,"!S 1 0_!S 2 0\r");				//vitesse du robot a 0 --> il va freiner

	            if(Time_detected==0) // recuperation du temps de la detection
	            {
	               Time_detected = GameTimeS;
	            }
	            else if(((GameTimeS - Time_detected) >= TIME_tempo_dectected))//on attend 6s
	            {      
	               if(TabObjectifs[(NoObj+1)][1][8]!=10 && TabObjectifs[(NoObj+1)][1][8]!=0)//si obj suivant pond entre 1 et 9 --> on switch l'obj
	               {
	                   /////////////////// actualisation position x,y ///////////////////
	                  __actual_pos();// actualisation de la Pos xy 

	                   /////////////////// effacer l'ordre en cours  /////////////////// 
	                  fprintf(ROBOTEQ,"^MMOD 1 0_^MMOD 2 0\r"); //passage en open loop speed
	                  delay_ms(10);
	                  fprintf(ROBOTEQ,"^MMOD 1 3_^MMOD 2 3\r"); //passage en closed loop count postion

	                   /////////////////// Passage a l'obj suivant  ///////////////////
	                  NoObj++; // passage a l'objectif suivant
	                  NoPts = 1; // on demarre par le premier pts
	                  __LoadObj(NoObj,NoPts);//charge le nouveau pts
	               
	                  if(Pt_commun!=0)//si point pas symetrique
	                  {
	                  if(Team)//pt droite
	                  {
	                     if(Pt_commun==1) NoPts++; // passe à l'obj suivant (pt droite)
	                  }
	                  }
	                  Etat_rob = Init; // on recommence le programme
	                  _Detected = 0;
	                  balise_on = 0;
	                  Dist_x = 0;
	                  Dist_y = 0;
	                  Dorient = 0; 
	                  _LED2,_LED3,_LED4 = 0;
	                  Time_detected=0;
	               }
	            }
	        }
	        else if(_Detected && tempo_bal == 4) // si detecte et que l'adv n'est plus la 
	        {
	             /////////////////// Reprise de l'ordre  ///////////////////         
	            fprintf(ROBOTEQ,"^MDEC 1 6000_^MDEC 2 6000\r");//on reprend le dernier ordre   
	            fprintf(ROBOTEQ,"!S 1 %u_!S 2 %u\r",oVitMax,oVitMax);

	            Time_detected = 0; 
	            _LED1=0;
	            _Detected = 0;
            
	        }
	        _LED1=!_LED1; 
	        flagBaliseCheck = 0;
	    }   

		/////////////////////////////////////////////////////////////////////////////////////
		///////////////////////        UART            //////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////
		if(PCh_flagUARTReadyToDecode) __UART_Decode(TabDecoded);


		/////////////////////////////////////////////////////////////////////////////////////
		///////////////////////        Fin du prog.    //////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////
		if((Flag_end || flagTimeOut || flag_error) && !IsPassedTimeOut)
		{
			__Afficheur_7segments(98);

			IsPassedTimeOut=1;
			// arret moteurs
			fprintf(ROBOTEQ, "!EX \r"); 
			driver_moteur(0xC0,0);
			driver_moteur(0xC2,0);
			driver_moteur(0xC4,0);
			Etat_rob = Wait_end;
		}		
	
}


/**
* \fn void TIMER1_isr(void)
* \author Amand Axel
* \version 2.0
* \date 19.10.2015
*
* \brief Met à jour la pose, gère le profil trapézoïdal et le PID
*		 S'active chaque 1 [ms]
*
*/
#INT_TIMER1 HIGH
void TIMER1_isr(void)
{
	// Compte le temps réel
	RealTimeMS ++;
	// Temps de jeu
	if(BeginTimeMS!=0)
	{
		GameTimeMS=RealTimeMS-BeginTimeMS;
		if(GameTimeMS%1000==0)GameTimeS++;
	}	
	
	////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////	TASK GIVER	////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////
	// Balise à checker
	if(GameTimeS == 92) FlagGameEnd = 1; 
	if(BeginTimeMS!=0 && GameTimeMS%TIME_TO_CHECK_BAL==0)
	{
		// Check Balise
		flagBaliseCheck=1;
	}
	if(BeginTimeMS!=0 && GameTimeMS%500==0)ToDisplay=!ToDisplay;
	////////////////////////////////////////////////////////////////////////////////////
	
	////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////	WATCHDOG INTERRUPTS	////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////
	// WD Times
	static unsigned int16 UART_WD_TIME=0;
	
	// Watchdog UART, réinitialise la capture
	if(PCh_flagUARTWatchdog==1)
	{
		UART_WD_TIME++;
		if(UART_WD_TIME>=UART_WD_DELAY)
		{
			// Reset UART
			ToDoUART = 0;
			PosTabToDecode=0;
			UARTToSendBack=0;
			UARTWaitResp=0;
			// Desactive le watchdog UART
			PCh_flagUARTWatchdog = 0;
		}
	}
	else UART_WD_TIME=0;
	////////////////////////////////////////////////////////////////////////////////////

	////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////		PROGRAM END		////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////
	// Après 1min30, on arrête les éléments essentiels
	if(BeginTimeMS!=0 && GameTimeS>=88)
	{
		flagTimeOut=1;
	}
	// Après la fin de jeu, on ouvre le parasol 
	if(BeginTimeMS!=0 && GameTimeS>=92)
	{
		flagGameEnd=1;
	}	
}

////////////////////////////////////////
//// Timer de clignotement d'erreur. ////
////////////////////////////////////////
#INT_TIMER3
void TIMER3_isr(void)
{
	static int1 On_Off_Error = 0;
	
	// Si doit afficher une erreur
	if(flagError)
	{
	//	__Afficheur_7segments(NO_ERROR,On_Off_Error);
		On_Off_Error =! On_Off_Error;
	}	
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    