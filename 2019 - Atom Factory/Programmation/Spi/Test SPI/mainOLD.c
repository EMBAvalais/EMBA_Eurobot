/*====================================================================================                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   /*====================================================================================================
=											EMVs - EUROBOT	  						==
===											--------------							==
======================================================================================
===	 Auteur				: Borgwat RÃƒÂ©my				  								==
===  Date				: 26.2.16													==
===  Nom du programme 	: InterfaceRoboteQ.mcp (fichier main.c)						==
===  Version 			: V2.0.0.0.0												==

======================================================================================
=== Description :																
	=== 																			==
	==============================================================*/	

#include "30F6014A.h"

#device ICD=TRUE
#device ADC=10

// Fuses
#fuses NOWDT, HS2_PLL8, NOPUT, NOPROTECT, DEBUG, NOBROWNOUT, NOWRT

// DÃƒÂ©finit la vitesse du quartz (prendre en compte si PLL employÃƒÂ©e)

#use delay(clock=80000000)

#build(stack=1024)
// Config IIC

#use i2c(master,force_hw,SLOW,I2C1)
// Config RS232
#use rs232(baud=115200,parity=N,xmit=PIN_F3,rcv=PIN_F2,bits=8,stream=ROBOTEQ/*UART*/) // Pour pouvoir utiliser le RS232/1
//#use rs232(baud=115200,parity=N,xmit=PIN_F5,rcv=PIN_F4,bits=8,stream=ROBOTEQ) // Pour pouvoir utiliser le RS232/2

#define BalSensitivity 3
#define Entraxe_roue 167
#define diametre_roue 9 // 72 /8 pour pas dépasser int32
#define impulsion_tour 11008 //nbre impulse encoder * reducteur * 4 = 88064 /8 pour pas dépasser int32
#define distance_1 50
#define d_capteur 670
#define pi 3.1416



// Variables utiles (globales)
int1 flag_servo = 0;
int1 flagTimeOut=0;   // dit que le temps est Ã©couler
int1 flagBaliseCheck=0;   // permet le check d'adversaire
unsigned int value_balise;
int1 Flag_check_cratere=0; //MODIFIE

	
int1 flag_depl_ok = 0;
unsigned int16 Time = 0;
//unsigned int8 Erreur_surchage_d1,Erreur_surchauffe_d1,Erreur_noconnect_d1,Erreur_surchage_d2,Erreur_surchauffe_d2,Erreur_noconnect_d2 = 0;
unsigned int8 Arret_Cratere = 0;

enum{action3_test1, action3_test2, stop, action1_avance1, action1_wait2, action1_avance3,action1_recule4, x14, fin_gauche}
Etat_prog_gauche = stop;

// Inclusion des fichiers sources

#include "DSPIC30F_registers.h"
#include <math.h>
#include "stdlib.h"
#include "Functions.h"



//********************************************************************************
//*  Main
//****************************************************************************************************
void main(void)
{
	__Init_dsPIC();

	signed int8 direction = 0;

	while(1)
 	{
	 	
/*	 		          set_adc_channel(3);
	                  delay_ms(10);
	                  int value = read_adc();
	                  
	        */       
	 	
 		direction = 0;

		if(direction==0)
		{
			_LED1=1;
			switch(Etat_prog_gauche)//cÃ´te gauche (violet)
			{
               case stop :                                                               
                  if(true)                           // Si on a starter le robot if(_Dig1==1)
                  { 
	                 _Tim1On= 1;
                     flag_depl_ok=0;//???
                     __Afficheur_7segments(0);               // incrÃ©mentation de l'afficheur 7 segements
                     Etat_prog_gauche = action1_avance1;         // permet de passer au mouvement suivant    
                  }
                  break; 
                  
               case action1_avance1 :
                  //__Avance(414000,2000);                     //Fonction pour faire avancer le robot 
                  __Avance(291900,1500);                     //Fonction pour faire avancer le robot 
                  //__Recule(304000,2000);                     //Fonction pour faire avancer le robot 
                  //__Recule(412000,2200);                     //Fonction pour faire avancer le robot               
                  __Afficheur_7segments(1);                  //incrÃ©mentation de l'afficheur 7 segements
                  Etat_prog_gauche = action1_wait2;            //permet de passer au mouvement suivant   
                  break;

             
              
              case action1_wait2 :
            	__Check_commande_atteint();                  //fonction qui check si le dÃ©placement Ã  Ã©tÃ© effectuÃ©
	              if(flag_depl_ok == 1)                     //si le dÃ©placement est fini
	              {
		              delay_ms(2000);
	              	_Tim3On=0;
	                flag_depl_ok = 0;                     //remise Ã Â  0 de la variable pour pouvoir la rÃ©utiliser
	                //__Recule(291900, 2000);                  //Fonction pour faire avancer le robot               
	          		__Afficheur_7segments(2);                  //incrÃ©mentation de l'afficheur 7 segements
	          		Etat_prog_gauche = action1_avance3;            //permet de passer au mouvement suivant                  
	              } 
	              else
                  {
	                  set_adc_channel(3);
	                  int value = read_adc();
	                  if(value > 500)
	                  {
		                _LED3 =1;
	                  	fprintf(ROBOTEQ,"!S 2 380_!S 1 200 \r");
	                  }	
	                  else if(value < 485)
	                  {
	                  	_LED3 =0;
	                  	fprintf(ROBOTEQ,"!S 2 1400_!S 1 1500 \r");	                  	
	                  	//delay_ms(1000);
	                  	//fprintf(ROBOTEQ,"!S 2 1500_!S 1 1500 \r");
	                  }
	                  else
	                  {
		                  fprintf(ROBOTEQ,"!S 2 1500_!S 1 1500 \r");
		                 } 
	              }   
              break;
              
              case action1_avance3 :
            	__Check_commande_atteint();                  //fonction qui check si le dÃ©placement Ã  Ã©tÃ© effectuÃ©
	              if(flag_depl_ok == 1)                     //si le dÃ©placement est fini
	              {
		              
	              	_Tim3On=0;
	                flag_depl_ok = 0;                     //remise Ã Â  0 de la variable pour pouvoir la rÃ©utiliser
	                __Avance(376000, 1500);                  //Fonction pour faire avancer le robot               
	          		__Afficheur_7segments(4);                  //incrÃ©mentation de l'afficheur 7 segements
	          		Etat_prog_gauche = action1_recule4;            //permet de passer au mouvement suivant                  
	              }    
              break;
              
              case action1_recule4 :
            	__Check_commande_atteint();                  //fonction qui check si le dÃ©placement Ã  Ã©tÃ© effectuÃ©
	              if(flag_depl_ok == 1)                     //si le dÃ©placement est fini
	              {
		              delay_ms(5000);
	              	_Tim3On=0;
	                flag_depl_ok = 0;                     //remise Ã Â  0 de la variable pour pouvoir la rÃ©utiliser
	                __Recule(647900, 2000);                  //Fonction pour faire avancer le robot               
	          		__Afficheur_7segments(5);                  //incrÃ©mentation de l'afficheur 7 segements
	          		Etat_prog_gauche = 999;            //permet de passer au mouvement suivant                  
	              } 
	              else
                  {
	                  set_adc_channel(3);
	                  int value = read_adc();
	                  if(value > 520)
	                  {
		                _LED3 =1;
	                  	fprintf(ROBOTEQ,"!S 2 400_!S 1 150 \r");
	                  }	
	                  else if(value < 485)
	                  {
	                  	_LED3 =0;
	                  	fprintf(ROBOTEQ,"!S 2 1400_!S 1 1500 \r");	                  	
	                  	//delay_ms(1000);
	                  	//fprintf(ROBOTEQ,"!S 2 1500_!S 1 1500 \r");
	                  }
	                  else
	                  {
		                  fprintf(ROBOTEQ,"!S 2 1500_!S 1 1500 \r");
		                 } 
	              }   
              break;
              
              
            }         
		}	

 	}	
		
	
}
//----------------------------------------------------------------------------------------------------
//  Nom: 	    RDA_isr
//	Auteur :	AMANAX
//	Date:	    27.03.2015
//  Statut :    OK
//----------------------------------------------------------------------------------------------------
//  Description : Interruption pour la rÃ©ception RS232. 
#INT_RDA
void RDA_isr(void)
{
	_LED3=!_LED3;
	// Pour la lecture du caractÃ¨re reÃ§u
	char myChar;
	// RÃ©ception
	myChar = fgetc(ROBOTEQ);
	// Ajout au buffer et incrÃ©mentation de la longeur du buffer
	RoboteQ_receiveBuffer[RoboteQ_receiveLenght] = myChar;
	RoboteQ_receiveLenght++;
	
	// Si on trouve la fin de la commande
	if(myChar == '\r')
	{
		// On dit qu'on peut lire le buffer de rÃ©ception
		RoboteQ_receiveToProceed = RoboteQ_receiveLenght;
		RoboteQ_receiveLenght=0;
	}

}

////////////////////////////////////////
//// Timer temps de jeu////
////////////////////////////////////////
#INT_TIMER1
void TIMER1_isr(void)
{
	if(Flag_Arret_Moteur)			//MODIFIE
	{								//MODIFIE
		Timer_Arret_Moteur++;		//MODIFIE
		if(Timer_Arret_Moteur>25)	//MODIFIE
			Timer_Arret_Moteur=25;	//MODIFIE
	}								//MODIFIE
	else							//MODIFIE
	{								//MODIFIE
		Timer_Arret_Moteur=0;		//MODIFIE
	}								//MODIFIE
	//12 secondes pour poser poisson sans se recaler environ
	//3 eme passage on ne se recal pas si pas 12 secondes alors o n fait allez retour
	_LED2=!_LED2;
	// Variable contenant le temps restant (90*5 (<=200[m]) = 450)
	set_timer1(0);
	// Incrémente le temps 
	Time++;
	// Si temps terminee
	if(Time>=440)//après 88secondes
	{
		// Dit que temps dÃ©passer
		flagTimeOut = 1;
		//__Afficheur_7segments(99); //MODIFIE		
	}	
	if(Time>=460)
	{
		flag_servo =1;		
		disable_interrupts(INTR_GLOBAL);
		//__Afficheur_7segments(00); //MODIFIE
	}

}
////////////////////////////////////////////////////////////////
//// Timer qui sert Ã  la capture de la balise ////
///////////////////////////////////////////////////////////////
#INT_TIMER3
void TIMER3_isr(void)
{
	_LED1=!_LED1;
	flagBaliseCheck=1;
}